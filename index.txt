<html>
<head>
<title>
Tab Title
</title>

<style>
name {
color: #FFFFFF;
}
body{
	background-color:#bed2be;
}
.formStyle{
margin-top: 6px;
}
table
{
border-collapse:collapse;
}
	
</style>
</head>
<body>




<?php
//still letting blank spaces in, i guess it can be guest account
require "util.php";
$user = $pass = "";
$userErr = $passErr = "";
$testNotFound = $studentNameErr = "";

if ($_SERVER["REQUEST_METHOD"] == "POST"){	
	if(isset($_POST['action']) && $_POST['action'] == "login"){//login is pressed
		if(empty($_POST['user'])){//error message
			$userErr = "Field required";
		} else {
			$userErr = "";
			$user = get_input($_POST["user"]);
		//}
		if(empty($_POST['pass'])){//error message
			$passErr = "Field required";
		} else {
			$passErr = "";
			$pass = get_input($_POST["pass"]);
		//}
		$file=fopen("users.dat","r") or exit("Unable to open file!");
		while(!feof($file)){//loop through the accounts in search for a user and pass, redirects

			if(trim(fgets($file)) == $user){
				$userErr = "";
				if(trim(fgets($file)) == $pass){
					session_start();
					$_SESSION['question'] = new Question();//active temp question. Will be added to test.
					$_SESSION['variables'] = array();//for dynamic question
					$_SESSION['test'] = new Test();//active test, cannot have initializer
					$_SESSION['name'] = $user;
					$_SESSION['chosen'] = $_SESSION['correct'] = array(); 
					header("location: dev.php");
					fclose($file);
				} else {
					fgets($file);
					$passErr = "Password doesn't match";
				}
			} else {
				$userErr = "Is not a real user";
				fgets($file);
				fgets($file);
			}
		}
		fclose($file);
		}
		}
	}
	if(isset($_POST['action']) && $_POST['action'] == "assess"){//Start Assessment was pressed
		$fileName = get_input($_POST["name"]).".txt";
		$studentName = get_input($_POST["studentName"]);
		if(file_exists($fileName)){//test found
			$testNotFound = "";
			if($studentName != ""){//name is entered
				$studentNameErr = "";
				session_start();
				$file = fopen($fileName, "r");
				session_decode(fgets($file, 40000));//open test session
				fclose($file);
				$tempTest = clone($_SESSION['test']);
				session_destroy();//end session, so only the test is taken from the session & not everything else in account
				session_start();
				$_SESSION['name'] = get_input($_POST["name"]);
				$_SESSION['studentName'] = $studentName;//sort test
				$_SESSION['sortedTest'] = $tempTest;//sort test
				//for each dynamic question, make the question and answer
				for($i=0;$i<count($_SESSION['sortedTest']->questions);$i++){
					$_SESSION['sortedTest']->questions[$i]->makeQuestion();
				}
				//--------------------------------------------
				$_SESSION['sortedTest']->correctAnswers = shuffleCorrect($_SESSION['sortedTest']);
				header("location: assess.php");
			} else {
				$studentNameErr = "Please Enter Your Name.";
			}
		} else {//test is found
			$testNotFound = "Test ".$fileName." Not Found";
		}
	}
}
?> 


<table width="80%" border="0" cellpadding="0" cellspacing="0">
	<tr>
		<td align="center" valign="middle" height="80" bgcolor="FFFFFF">
			<div class="title">
				Student Assessment Developer
			</div>
		</td>
	</tr>
	<tr>
		<td align="center"><br/><br/>&nbsp;
			<table width="800" border="5" cellpadding="10" cellspacing="10">
				<tr>
					<td width="48%">
						<p style="font-size:14px;">
						Make your own test. Take other people's tests. Free of charge.<br/>
						It's all online, so no trees die and no pollution is produced from out-of-date paper tests.
						</p>
					</td>
					
					<td width="48%">
						<form method="post">
						<div class="formStyle" style="margin-left:100px;"><b>Login</b></div>
						<div class="formStyle">username <input type="text" name="user"/><?php echo $userErr;?></div>
						<div class="formStyle">password <input type="password" name="pass"/><?php echo $passErr;?></div>
						<div align="center" class="formStyle"><input type="submit" value="Submit"/>
						<input type='hidden' name='action' value='login' /></div>
						</form>
						<form action="register.php">
						<div class="formStyle"><input type="submit" value="Register Account"/></div>
						</form>
					</td>
				</tr>
			</table>
		</td>
	</tr>
	<tr>
		<td align="center"><br/>
			<form method = "post">
			Student Name: <input type="text" name='studentName'><?php echo $studentNameErr;?><br/>
			Test Name: <input type="text" name='name'><?php echo $testNotFound;?><br/>
			<input type = "submit" value = "Start Assessment" >
			<input type='hidden' name='action' value='assess' />
			</form>
			<br/><br/>&nbsp;
		</td>
	</tr>
</table>
</body>
</html>